<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>后台管理系统</title>
  <script src="./js/jquery.min.js"></script>
  <script src="./layui/layui.js"></script>
  <script src="./js/public.js"></script>
  <link rel="stylesheet" href="./layui/css/layui.css">
</head>

<body class="layui-layout-body">
  <div class="layui-layout layui-layout-admin">
    <div class="layui-header">
      <div class="layui-logo">后台管理系统</div>
      <ul class="layui-nav layui-layout-right">
        <li class="layui-nav-item"><a class="clear_cache" href="javascript:"><i class="layui-icon">&#xe640;</i> 清除缓存</a>
        </li>
        <li class="layui-nav-item">
          <a href="javascript:;">
            <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
            贤心
          </a>
          <dl class="layui-nav-child">
            <dd><a href=""><i class="layui-icon">&#xe673;</i> 修改密码</a></dd>
            <dd><a href=""><i class="layui-icon">&#xe65c;</i> 退出</a></dd>
          </dl>
        </li>
      </ul>
    </div>
    <div class="layui-side layui-bg-black">
      <div class="layui-side-scroll">
        <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
        <ul class="layui-nav layui-nav-tree">
          <li class="layui-nav-item"><a href=""><i class="layui-icon">&#xe68e;</i> 首页</a></li>
          <li class="layui-nav-item layui-this"><a href="public"><i class="layui-icon">&#xe62a;</i> 网站信息</a></li>
          <li class="layui-nav-item">
            <a class="" href="javascript:;">所有商品</a>
            <dl class="layui-nav-child">
              <dd><a href="javascript:;">列表一</a></dd>
              <dd><a href="javascript:;">列表二</a></dd>
              <dd><a href="javascript:;">列表三</a></dd>
              <dd><a href="">超链接</a></dd>
            </dl>
          </li>
          <li class="layui-nav-item">
            <a href="javascript:;">解决方案</a>
            <dl class="layui-nav-child">
              <dd><a href="javascript:;">列表一</a></dd>
              <dd><a href="javascript:;">列表二</a></dd>
              <dd><a href="">超链接</a></dd>
            </dl>
          </li>
          <li class="layui-nav-item"><a href="">云市场</a></li>
          <li class="layui-nav-item"><a href="">发布商品</a></li>
        </ul>
      </div>
    </div>
    <div class="layui-body" style="padding: 20px">
      <div class="layui-card">
        <span class="layui-breadcrumb">
          <a href="">后台管理系统</a>
          <a href="">网站信息</a>
          <a class="active" href="">添加网站信息</a>
        </span>
      </div>
      <div class="layui-content">
        <form class="layui-form">
          <div class="layui-form-item">
            <label class="layui-form-label">网站LOGO</label>
            <div class="layui-input-block">
              <label>
                <input type="file" name="logo" id="logo" />
                {% if data.logo %}
                <img class="logo_img" src="{{ data.logo }}" alt="" />
                {% else %}
                <span type="button" class="layui-btn logo_btn">
                  <i class="layui-icon">&#xe67c;</i>上传LOGO
                </span>
                {% endif %}
              </label>
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">网站关键字</label>
            <div class="layui-input-block">
              <input type="text" name="keyword" placeholder="请输入网站关键字" class="layui-input" value="{{ data.keyword }}">
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">网站描述</label>
            <div class="layui-input-block">
              <textarea name="desc" placeholder="请输入网站描述" class="layui-textarea">{{ data.keyword }}</textarea>
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">服务热线</label>
            <div class="layui-input-block">
              <input type="text" name="hotline" placeholder="请输入服务热线" class="layui-input" value="{{ data.hotline }}">
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">天猫商城</label>
            <div class="layui-input-block">
              <input type="http" name="tmall" placeholder="请输入天猫商城地址" class="layui-input" value="{{ data.tmall }}">
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">英文网站</label>
            <div class="layui-input-block">
              <input type="http" name="en" placeholder="请输入英文网站地址" class="layui-input" value="{{ data.en }}">
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">网站备案号</label>
            <div class="layui-input-block">
              <input type="text" name="copyright" placeholder="请输入网站备案号" class="layui-input"
                value="{{ data.copyright }}">
            </div>
          </div>
          <input type="hidden" name="id" value="{{ data._id.toString() }}">
          <div class="layui-form-item">
            <div class="layui-input-block">
              <a class="layui-btn update">修改信息</a>
              <a class="layui-btn layui-btn-primary" onclick="window.history.go(-1);">返回</a>
            </div>
          </div>
        </form>
      </div>

    </div>
    <div class="layui-footer">
      <!-- 底部固定区域 -->
      底部固定区域
    </div>
  </div>

  <style>
    #logo {
      width: 0;
      height: 0;
      visibility: hidden;
      display: none;
    }

    .logo_img {
      display: block;
      height: 100px;
    }
  </style>
  <!-- //JavaScript代码区域 -->
  <script>
    $(function () {
      layui.use(['element', 'jquery', 'form', "layer"], function () {
        var element = layui.element;
        var $ = layui.jquery;
        var form = layui.form;
        var layer = layui.layer;

        $('#logo').change(function () {
          var _file = $(this);
          var _fileObj = _file[0];
          var windowURL = window.URL || window.webkitURL;
          var dataURL;
          var img = $(".logo_img");
          if (_fileObj.files[0].type.indexOf('image') == -1) {
            _file.val("");
            layer.msg("LOGO只支持图片类型", {
              time: 1000
            });
            return;
          }
          if (_fileObj && _fileObj.files && _fileObj.files[0]) {
            dataURL = windowURL.createObjectURL(_fileObj.files[0]);
            img.show().attr('src', dataURL);
            $('.logo_btn').hide();
          } else {
            dataURL = _file.val();
            var imgObj = img[0];
            imgObj.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
            imgObj.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = dataURL;
          }
        })
        $('.update').click(function () {
          var _logo = $('input[name="logo"]').val();
          var _keyword = $('input[name="keyword"]').val();
          var _desc = $('textarea[name="desc"]').val();
          var _hotline = $('input[name="hotline"]').val();
          var _tmall = $('input[name="tmall"]').val();
          var _en = $('input[name="en"]').val();
          var _copyright = $('input[name="copyright"]').val();
          var _id = $('input[name="id"]').val();

          var _sendData = {
            id: _id,
            keyword: _keyword,
            desc: _desc,
            hotline: _hotline,
            tmall: _tmall,
            en: _en,
            copyright: _copyright
          }

          if (_logo == "") { //没上传LOGO
            _sendData.logo = "";
            addPublic(_sendData)
          } else {
            //上传图片的input
            var file = document.getElementById("logo");
            //创建formdata对象
            var formData = new FormData();
            //给formdata对象中放入数据(键值对的方式)
            formData.append('file', file.files[0]);
            //提交请求
            $.ajax({
              url: '/api/upload',
              type: 'POST',
              data: formData,
              contentType: false,
              processData: false,
              success: function (data) {
                if (data.code == 200) {
                  _sendData.logo = data.data;
                  addPublic(_sendData)
                } else {
                  layer.msg("添加失败", {
                    time: 1000
                  });
                }
              },
              error: function () {
                layer.msg("与服务器通信发生错误", {
                  time: 1000
                });
              }
            });
          }
        })

        function addPublic(data) {
          $.ajax({
            url: '/api/public_update', //请求路径
            type: 'POST',
            data: data,
            success: function (data) {
              if (data.code == 200) {
                layer.msg(data.msg, {
                  time: 1000
                });
                setTimeout(function () {
                  return;
                  window.location.href = "public";
                }, 1000)
              } else {
                layer.msg(data.msg, {
                  time: 1000
                });
              }
            },
            error: function () {
              layer.msg("与服务器通信发生错误", {
                time: 1000
              });
            }
          });
        }
      })
    })
  </script>
</body>

</html>